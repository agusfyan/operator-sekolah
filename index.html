<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UPTD SD Negeri 2 Tanjung Qencono</title>
<link rel="icon" href="https://iili.io/FSNupqu.png" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg:#f5f7fb; --card:#fff; --muted:#0055ff;
  --accent:#0b5ed7; --accent-2:#2b6ea3;
  --gray:#d5fe04; --shadow: 0 6px 16px rgba(0,0,0,0.2);
  --gold:#04ff71; --dongker:#1e3a8a;
}
[data-theme="dark"] {
  --bg:#0b1220; --card:#848484; --muted:#006aff;
  --accent:#d5fe04; --accent-2:#d5fe04; --gray:#d5fe04;
}
/* Default warna teks Operator Sekolah */
.brand h1 {
  color: var(--dongker);
}
/* Saat dark mode aktif */
[data-theme="dark"] .brand h1 {
  color: #ffffff;
}
  table th,table td{padding:8px;border-bottom:1px solid var(--gray);}
table th{background:#7ebeff;color:var(--dongker);}
  
*{box-sizing:border-box;font-family:Inter,system-ui;}
body{margin:0;background:var(--bg);color:var(--dongker);transition:background .3s,color .3s;}
.app{max-width:1200px;margin:auto;padding:16px;}
.header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:20px;}
.brand{display:flex;gap:10px;align-items:center;flex:1;}
.logo{width:52px;height:52px;border-radius:12px;background:#fff;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;}
.logo img{width:100%;height:100%;object-fit:contain;}
h1{margin:0;font-size:20px;font-weight:700;}
p.lead{margin:0;color:var(--muted);font-size:13px;}
.layout{display:grid;grid-template-columns:240px 1fr;gap:16px;}
@media(max-width:900px){.layout{grid-template-columns:1fr;}}
.sidebar{background:var(--card);padding:12px;border-radius:12px;box-shadow:var(--shadow);}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;color:var(--muted);cursor:pointer;transition:.2s;font-size:14px;}
.nav-item:hover{background:var(--gray);color:var(--muted);}
.nav-item.active{background:linear-gradient(90deg,rgba(11,94,215,0.1),rgba(43,110,163,0.05));color:var(--accent);font-weight:600;}
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);}
footer{text-align:center;color:var(--muted);font-size:12px;margin-top:24px;}
.switch{width:44px;height:24px;background:#d5fe04;border-radius:999px;position:relative;cursor:pointer;}
.switch .knob{position:absolute;left:3px;top:3px;width:18px;height:18px;border-radius:50%;background:#000000;transition:all .2s;}
.switch.on{background:linear-gradient(90deg,var(--accent),var(--accent-2));}
.switch.on .knob{left:23px;}
table{width:100%;border-collapse:collapse;font-size:13px;}
table th,table td{padding:8px;border-bottom:1px solid var(--gray);}
table th{background:#7ebeff;color:var(--dongker);}
.center{text-align:center;}
input,select{padding:6px;border-radius:6px;border:1px solid var(--gray);}
button{padding:6px 12px;border-radius:6px;border:none;background:var(--dongker);color:#fff;cursor:pointer;transition:0.2s;}
button:hover{background:var(--gray);color:#625e5e;}
.dashboard-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  align-items:start;
}
  #studentsTable th, 
#studentsTable td {
  text-align: center;
  vertical-align: middle;
}

#studentsTable select {
  text-align: center;
  display: block;
  margin: auto;
}
@media(max-width:800px){
  .dashboard-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">
      <div class="logo"><img src="https://iili.io/FSNupqu.png" alt="Logo SDN 2 Tanjung Qencono"></div>
      <div>
        <h1>Operator Sekolah</h1>
        <p class="lead">UPTD SD Negeri 2 Tanjung Qencono</p>
      </div>
    </div>
    <div id="darkToggle" class="switch" title="Dark Mode"><div class="knob"></div></div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div class="nav-item active" data-page="dashboard">üìä Dashboard</div>
      <div class="nav-item" data-page="absen">üìù Absensi</div>
      <div class="nav-item" id="menuEdit">‚úèÔ∏è Edit</div>
    </aside>

    <main class="content">
      <!-- DASHBOARD -->
      <section id="page-dashboard" class="card">
        <h2>üìà Rekap Kehadiran Siswa</h2>
        <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px;">
          <label>Pilih Kelas:
            <select id="kelasSelect">
              <option>Kelas 1</option><option>Kelas 2</option><option>Kelas 3</option>
              <option>Kelas 4</option><option>Kelas 5</option><option>Kelas 6</option>
            </select>
          </label>
          <label>Filter Tanggal:
            <input type="date" id="filterDate">
          </label>
          <button id="refreshDashboard">üîÑ Refresh</button>
        </div>
        <p id="waliKelasName">Wali Kelas: -</p>

        <div class="dashboard-grid">
          <div class="card">
            <canvas id="statsChart" height="250"></canvas>
          </div>
          <div class="card" style="overflow:auto;max-height:433px;">
            <table>
              <thead><tr><th>Nama</th><th>NISN</th><th>Status</th><th>Tanggal</th></tr></thead>
              <tbody id="attendanceTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ABSENSI -->
      <section id="page-absen" class="card" style="display:none">
        <h2>üìù Absensi Siswa</h2>
        <p id="waliKelasName2">Wali Kelas: -</p>
        <table id="studentsTable">
          <thead><tr><th>Nama</th><th>NISN</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
          <button id="markAllPresent">‚úÖ Hadir Semua</button>
          <button id="submitAttendance">üì§ Kirim Absensi</button>
        </div>
      </section>
    </main>
  </div>

  <footer>¬© <span id="copyrightYear"></span> UPTD SD Negeri 2 Tanjung Qencono</footer>
</div>

<script>
function getDateGMT7(d=new Date()){
  const tzOffset=7*60;
  const local=new Date(d.getTime()+(tzOffset+d.getTimezoneOffset())*60000);
  const yyyy=local.getFullYear();
  const mm=String(local.getMonth()+1).padStart(2,'0');
  const dd=String(local.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

// API per kelas
const CLASS_API={
  "Kelas 1":"https://script.google.com/macros/s/AKfycbwPE1mmoLU0S7FwwFCJ0Q5kMWU-P7kIBnENmq7EzH6IvkhSRtJDBzGb1UzIkzfAFAgzqQ/exec",
  "Kelas 2":"https://script.google.com/macros/s/AKfycbyNqy7VxUHJBKtgpDpW0ABc1s8A8VY3iMhfZspxXrkAX0TQyM_MLVXtgvB-2R6k635d4A/exec",
  "Kelas 3":"https://script.google.com/macros/s/AKfycbwQy1zoccq_1yCJsbS3DdzMoAyatN_XBocddQ7HWCBEXN-CLjEXbGlX61mNA7MUeirIUw/exec",
  "Kelas 4":"https://script.google.com/macros/s/AKfycbxUCADnTYb5MTqM6bqu13fzkPLaAqDIkOvPLKZ3Esz2U1jL1nGjvSytXY4Gftqs_N76/exec",
  "Kelas 5":"https://script.google.com/macros/s/AKfycbw93ApzsSBccOHGOpINgYZLmY-sONHbDdzRejPE_DV25k9CtyiDHkNqjO7b4NfgFMF-Cg/exec",
  "Kelas 6":"https://script.google.com/macros/s/AKfycbwP89RXgznibsHz4_rqVxQiNX3F8m2Z90U_AWvvy-TgUVU5EslhYQ3t8fRW_ijMJW4/exec"
};

// Sheet ID
const SHEET_ID={
  "Kelas 1":"1vaD3tAejkyUdx-7RaDj96BRD9m08V1vphX1x0j1ZISY",
  "Kelas 2":"1o4xcISpztp52yzXs58G-H_CL5MZhmEwqX8Ypyeh1qgg", 
  "Kelas 3":"1pkVsEG1kOsMeznf-7nzDn6BbFK85j8mFojEL10g5yM4",
  "Kelas 4":"170flmzqtxEBmtQYwbaaSnMtGyNFxMubwUJVUw1zMPDA",
  "Kelas 5":"1Vmd_hzuhL_LFypcyI-eBIpXUZ1lZzL9_OysYDS0PkoE",
  "Kelas 6":"1kBAUVHlP98RAUyuP0M5Na07RTYy-CaLM_xdTGvJTpZM"
};

let CURRENT_CLASS="Kelas 1";

const pages={dashboard:document.getElementById("page-dashboard"),absen:document.getElementById("page-absen")};
document.querySelectorAll(".nav-item[data-page]").forEach(n=>{
  n.onclick=()=>{Object.keys(pages).forEach(p=>pages[p].style.display=(p===n.dataset.page?"block":"none"));
  document.querySelectorAll(".nav-item[data-page]").forEach(x=>x.classList.toggle("active",x===n));};
});

// Menu Edit
document.getElementById("menuEdit").onclick=()=>{
  const sheetId=SHEET_ID[CURRENT_CLASS];
  if(sheetId){
    const url=`https://docs.google.com/spreadsheets/d/${sheetId}/edit`;
    window.open(url,"_blank");
  }else{
    alert("Sheet ID untuk "+CURRENT_CLASS+" belum diatur.");
  }
};

const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("theme")==="dark"){document.documentElement.setAttribute("data-theme","dark");darkToggle.classList.add("on");}
darkToggle.onclick=()=>{
  const dark=document.documentElement.getAttribute("data-theme")==="dark";
  if(dark){document.documentElement.removeAttribute("data-theme");localStorage.setItem("theme","light");darkToggle.classList.remove("on");}
  else{document.documentElement.setAttribute("data-theme","dark");localStorage.setItem("theme","dark");darkToggle.classList.add("on");}

  // update warna teks pada grafik
  if(statsChartInstance){
    statsChartInstance.options.plugins.legend.labels.color = dark ? "#000000" : "#ffffff";
    statsChartInstance.update();
  }
};

document.getElementById("copyrightYear").textContent=new Date().getFullYear();

async function apiGet(params){
  const url=CLASS_API[CURRENT_CLASS]+"?"+new URLSearchParams(params);
  const res=await fetch(url); const text=await res.text();
  try{return JSON.parse(text);}catch{return[];}
}
async function apiPost(params,body){
  const url=CLASS_API[CURRENT_CLASS]+"?"+new URLSearchParams(params);
  const form=new URLSearchParams(); form.append("payload",JSON.stringify(body));
  const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:form});
  return res.json();
}

async function loadWaliKelas(){
  try{const wali=await apiGet({action:"getwali"});
    document.getElementById("waliKelasName").textContent="Wali Kelas: "+(wali.nama||"-");
    document.getElementById("waliKelasName2").textContent="Wali Kelas: "+(wali.nama||"-");
  }catch{}
}
async function loadStudents(){
  const body=document.querySelector("#studentsTable tbody");
  body.innerHTML="<tr><td colspan=3 class=center>Memuat...</td></tr>";
  try{
    const data=await apiGet({action:"getstudents"});
    body.innerHTML="";
    data.forEach(s=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${s.Nama||""}</td><td>${s.NISN||""}</td><td><select><option>Hadir</option><option>Izin</option><option>Alpha</option></select></td>`;
      body.appendChild(tr);
    });
  }catch(e){body.innerHTML=`<tr><td colspan=3 class=center>Gagal: ${e.message}</td></tr>`;}
}
async function loadAttendanceForDate(date){
  const body=document.getElementById("attendanceTable");
  body.innerHTML="<tr><td colspan=4 class=center>Memuat...</td></tr>";
  try{
    const data=await apiGet({action:"getattendance",since:date,to:date});
    if(!data||data.length===0){body.innerHTML="<tr><td colspan=4 class=center>Tidak ada data</td></tr>";renderStatsChart({Hadir:0,Izin:0,Alpha:0});return;}
    body.innerHTML="";
    const stats={Hadir:0,Izin:0,Alpha:0};
    data.forEach(r=>{
      stats[r.Status]=(stats[r.Status]||0)+1;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.Nama}</td><td>${r.NISN}</td><td>${r.Status}</td><td>${r.Tanggal}</td>`;
      body.appendChild(tr);
    });
    renderStatsChart(stats);
  }catch(e){body.innerHTML=`<tr><td colspan=4 class=center>Gagal: ${e.message}</td></tr>`;}
}
let statsChartInstance=null;
function renderStatsChart(stats){
  const ctx=document.getElementById("statsChart").getContext("2d");
  if(statsChartInstance) statsChartInstance.destroy();
  statsChartInstance=new Chart(ctx,{
    type:"doughnut",
    data:{labels:["Hadir","Izin","Alpha"],
          datasets:[{data:[stats.Hadir||0,stats.Izin||0,stats.Alpha||0],
                     backgroundColor:["#0b5ed7","#facc15","#ef4444"],
                     borderWidth:0}]},
     options:{plugins:{legend:{position:"bottom",labels:{color: document.documentElement.getAttribute("data-theme")==="dark" ? "#ffffff" : "#000000"}}},cutout:"70%",responsive:true}
  });
}
document.getElementById("kelasSelect").onchange=async e=>{
  CURRENT_CLASS=e.target.value;await loadWaliKelas();await loadStudents();await loadAttendanceForDate(document.getElementById("filterDate").value||getDateGMT7());
};
document.getElementById("refreshDashboard").onclick=()=>loadAttendanceForDate(document.getElementById("filterDate").value||getDateGMT7());
document.getElementById("filterDate").onchange=()=>loadAttendanceForDate(document.getElementById("filterDate").value||getDateGMT7());
document.getElementById("markAllPresent").onclick=()=>document.querySelectorAll("#studentsTable tbody select").forEach(s=>s.value="Hadir");
document.getElementById("submitAttendance").onclick = async () => {
  const entries = [];
  document.querySelectorAll("#studentsTable tbody tr").forEach(tr => {
    entries.push({
      Nama: tr.cells[0].textContent,
      NISN: tr.cells[1].textContent,
      Status: tr.cells[2].querySelector("select").value,
      Tanggal: getDateGMT7()
    });
  });

  try {
    const res = await apiPost({ action: "submitattendance" }, { entries });

    if (res.alreadySubmitted) {
      alert("Sudah absen hari ini, coba lagi besok");
    } else if (res.written && res.written > 0) {
      alert("Absensi berhasil dikirim");
      await loadAttendanceForDate(getDateGMT7());
    } else {
      alert("Sudah absen hari ini, coba lagi besok");
    }

  } catch (e) {
    alert("Sudah absen hari ini, coba lagi besok");
  }
};

document.getElementById("filterDate").value=getDateGMT7();
loadWaliKelas();loadStudents();loadAttendanceForDate(getDateGMT7());
</script>
</body>
</html>


